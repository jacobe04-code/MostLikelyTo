<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDU9G49CHpWAl_JDhhgeyiz8ezn5hg40Ek",
        authDomain: "mostlikelyto.firebaseapp.com",
        projectId: "mostlikelyto",
        storageBucket: "mostlikelyto.firebasestorage.app",
        messagingSenderId: "826481623010",
        appId: "1:826481623010:web:d28043916cd39278e803bb",
        measurementId: "G-1C20S44D0E"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    signInAnonymously(auth).catch(console.error);

    const game = {
        gameCode: null,
        playerName: null,
        players: {},
        isHost: false,
        unsubscribe: null,

        async createGame() {
            const name = document.getElementById('hostName').value.trim();
            if (!name) return alert('Please enter your name');

            // Prevent HTML injection in local state
            this.playerName = name.replace(/</g, "&lt;");
            this.isHost = true;
            this.gameCode = Math.random().toString(36).substring(2, 6).toUpperCase();

            try {
                await setDoc(doc(db, 'games', this.gameCode), {
                    status: 'lobby',
                    players: { [this.playerName]: { name: this.playerName, score: 0, isHost: true } }
                });
                this.startListening();
                this.showLobby();
            } catch (error) {
                console.error(error);
                alert("Permission denied. Check Console for details.");
            }
        },

        async joinGame() {
            const rawName = document.getElementById('joinName').value.trim();
            const code = document.getElementById('gameCode').value.trim().toUpperCase();
            if (!rawName || !code) return alert('Enter name and code');
            
            const safeName = rawName.replace(/</g, "&lt;");

            try {
                const gameRef = doc(db, 'games', code);
                const snap = await getDoc(gameRef);
                
                if (snap.exists()) {
                    // FIX: Atomic update using dot notation to prevent race conditions
                    // This ensures we don't overwrite other players joining simultaneously
                    await updateDoc(gameRef, {
                        [`players.${safeName}`]: { name: safeName, score: 0, isHost: false }
                    });

                    this.playerName = safeName;
                    this.gameCode = code;
                    this.startListening();
                    this.showLobby();
                } else {
                    alert("Room not found!");
                }
            } catch (error) {
                console.error(error);
                alert("Error joining. See console.");
            }
        },

        startListening() {
            if (this.unsubscribe) this.unsubscribe();
            this.unsubscribe = onSnapshot(doc(db, 'games', this.gameCode), (doc) => {
                if (doc.exists()) {
                    this.players = doc.data().players || {};
                    this.updateLobbyUI();
                }
            });
        },

        updateLobbyUI() {
            const list = document.getElementById('lobbyPlayers');
            list.innerHTML = '';
            Object.values(this.players).forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                
                // FIX: Use textContent to prevent XSS attacks
                const nameSpan = document.createElement('span');
                nameSpan.className = 'player-name';
                nameSpan.textContent = p.name;
                
                div.appendChild(nameSpan);
                if (p.isHost) div.append(' ðŸ‘‘');
                list.appendChild(div);
            });
            document.getElementById('lobbyCode').textContent = `CODE: ${this.gameCode}`;
        },

        // ... (Keep your existing UI toggle functions here) ...
        showCreateGame() { this.hideAll(); document.getElementById('createGameScreen').classList.add('active'); },
        showJoinGame() { this.hideAll(); document.getElementById('joinGameScreen').classList.add('active'); },
        showHome() { this.hideAll(); document.getElementById('homeScreen').classList.add('active'); },
        showLobby() { this.hideAll(); document.getElementById('lobbyScreen').classList.add('active'); },
        hideAll() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); }
    };

    // CRITICAL FIX: Expose game object to global scope so HTML onclick works
    window.game = game;
</script>
