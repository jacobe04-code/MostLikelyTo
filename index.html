<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do You Even Know Me?</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #ff0080;
            --text: #2d3748;
            --bg-card: #ffffff;
            --error: #e53e3e;
            --success: #38a169;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }

        .container {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 2rem;
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        h1 {
            color: var(--secondary);
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .screen {
            display: none;
            width: 100%;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        button {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        button.secondary {
            background: #e2e8f0;
            color: var(--text);
        }

        button.option-btn {
            background: #fff;
            border: 2px solid var(--primary);
            color: var(--primary);
            text-align: left;
            margin-bottom: 0.8rem;
            padding: 1rem;
        }

        button.option-btn:hover {
            background: #f7fafc;
            transform: translateX(5px);
        }

        /* Player selection buttons */
        .player-choice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 480px) {
            .player-choice-grid {
                grid-template-columns: 1fr;
            }
        }

        .player-choice-btn {
            background: #fff;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .player-choice-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .player-choice-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.4);
        }

        input {
            padding: 0.8rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 16px; /* Prevents zoom on iOS */
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .lobby-code-display {
            background: #f7fafc;
            border: 2px dashed var(--primary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .lobby-code {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            letter-spacing: 2px;
        }

        .player-list {
            text-align: left;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #edf2f7;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .host-badge {
            background: #fbd38d;
            color: #9c4221;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 1rem;
            font-weight: bold;
        }

        .game-header-info {
            background: #f7fafc;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 1rem;
        }

        .highlight-name {
            color: var(--secondary);
            font-weight: bold;
        }

        /* Leaderboard Styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .leaderboard-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #edf2f7;
        }
        .leaderboard-table tr:first-child td {
            font-weight: bold;
            color: var(--secondary);
        }

        /* Toast Notifications */
        #toast-container {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 90%;
        }

        .toast {
            background: #2d3748;
            color: white;
            padding: 0.8rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error { background: var(--error); }
        .toast.success { background: var(--success); }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .result-card {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: left;
        }
        .result-answer {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .points-badge {
            background: #38a169;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="toast-container"></div>

        <div id="header">
            <h1>üé≠ Do You Even Know Me?</h1>
            <p class="subtitle">How Well Do Your Friends Know You?</p>
        </div>

        <!-- SCREEN 1: HOME -->
        <div id="homeScreen" class="screen active">
            <button id="btnInitCreate" onclick="game.showCreateGame()" disabled>
                <div class="loading-spinner"></div> Create Game
            </button>
            <button id="btnInitJoin" onclick="game.showJoinGame()" class="secondary" disabled>
                <div class="loading-spinner"></div> Join Game
            </button>
            <p id="authStatus" style="font-size: 0.8rem; color: #a0aec0; margin-top: 1rem;">Connecting to server...</p>
        </div>

        <!-- SCREEN 2: CREATE -->
        <div id="createGameScreen" class="screen">
            <input type="text" id="hostName" placeholder="Enter your name" maxlength="12">
            <button id="btnCreate" onclick="game.createGame()">Create Room</button>
            <button onclick="game.showHome()" class="secondary">Back</button>
        </div>

        <!-- SCREEN 3: JOIN -->
        <div id="joinGameScreen" class="screen">
            <input type="text" id="joinName" placeholder="Enter your name" maxlength="12">
            <input type="text" id="gameCode" placeholder="Room Code (4 Letters)" maxlength="4" style="text-transform: uppercase;">
            <button id="btnJoin" onclick="game.joinGame()">Join Room</button>
            <button onclick="game.showHome()" class="secondary">Back</button>
        </div>

        <!-- SCREEN 4: LOBBY -->
        <div id="lobbyScreen" class="screen">
            <div class="lobby-code-display">
                <div style="font-size: 0.8rem; color: #718096; margin-bottom: 0.5rem;">ROOM CODE</div>
                <div id="lobbyCode" class="lobby-code"></div>
            </div>

            <h3 style="margin: 0; color: var(--text);">Waiting for Players...</h3>
            <div id="lobbyPlayers" class="player-list"></div>
            
            <button id="startGameBtn" style="display: none;" onclick="game.startGame()">Start Game</button>
            <button onclick="location.reload()" class="secondary">Leave Room</button>
        </div>

        <!-- SCREEN 5: GAMEPLAY -->
        <div id="gameScreen" class="screen">
            <!-- Phase 1: Setup (Everyone picks Q&A) -->
            <div id="phaseSetup" style="display: none;">
                <div id="setupStep1">
                    <h3>Pick Your Question</h3>
                    <p>Choose the question others will answer about YOU.</p>
                    <div id="setupOptions"></div>
                </div>
                <div id="setupStep2" style="display: none;">
                    <h3>Your Answer</h3>
                    <p id="mySelectedQuestion" style="font-weight: bold; color: var(--secondary);"></p>
                    <p>Who fits this best?</p>
                    <div id="setupPlayerOptions" class="player-choice-grid"></div>
                </div>
                <div id="setupWait" style="display: none;">
                    <h3>Waiting for others...</h3>
                    <div class="loading-spinner" style="border-color: var(--primary); border-top-color: transparent;"></div>
                    <p style="margin-top: 1rem; font-size: 0.9rem;">Everyone must finish before we start!</p>
                </div>
            </div>

            <!-- Phase 2: Voting (Round Robin) -->
            <div id="phaseVoting" style="display: none;">
                <div class="game-header-info">
                    Subject: <span id="votingSubject" class="highlight-name">---</span>
                </div>

                <h3 id="votingQuestion" style="color: var(--secondary); margin-bottom: 1.5rem;">---</h3>

                <div id="votingActive">
                    <p>Who did <span id="votingSubjectRef" class="highlight-name"></span> pick?</p>
                    <div id="votePlayerOptions" class="player-choice-grid"></div>
                </div>

                <div id="votingPassive">
                    <p>You are the subject! Relax and watch them guess.</p>
                    <div class="loading-spinner" style="border-color: var(--primary); border-top-color: transparent;"></div>
                </div>

                <div id="votingWait" style="display:none; color: #38a169; margin-top: 1rem;">Guess Submitted! Waiting for others...</div>
            </div>

            <!-- Phase 3: Results (Mini-Round Reveal) -->
            <div id="phaseResults" style="display: none;">
                 <h2 style="color: var(--secondary);">Round Results!</h2>
                 <p>Question: <b id="resultQuestion">---</b></p>

                 <div class="result-card">
                     <small>Subject's Answer (<span id="resultSubjectName"></span>):</small>
                     <div id="resultRealAnswer" class="result-answer">---</div>
                 </div>

                 <div id="guessesList" style="text-align: left;"></div>

                 <div id="hostControls" style="margin-top: 2rem; display: none;">
                     <button onclick="game.nextRound()">Next Round</button>
                 </div>
                 <div id="playerControls" style="margin-top: 2rem; display: none;">
                     <p>Waiting for host...</p>
                 </div>
            </div>

            <!-- Phase 4: Leaderboard -->
            <div id="phaseLeaderboard" style="display: none;">
                <h2>üèÜ Final Leaderboard</h2>
                <table class="leaderboard-table" id="finalScores"></table>
                <button onclick="location.reload()" style="margin-top: 2rem;">Back to Main Menu</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDU9G49CHpWAl_JDhhgeyiz8ezn5hg40Ek",
            authDomain: "mostlikelyto.firebaseapp.com",
            projectId: "mostlikelyto",
            storageBucket: "mostlikelyto.firebasestorage.app",
            messagingSenderId: "826481623010",
            appId: "1:826481623010:web:d28043916cd39278e803bb",
            measurementId: "G-1C20S44D0E"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const QUESTIONS_BANK = [
            "Who is most likely to become a millionaire by accident?",
            "Who is most likely to survive a zombie apocalypse?",
            "Who is most likely to cry during a sad movie?",
            "Who is most likely to forget their own birthday?",
            "Who is most likely to join a cult?",
            "Who is most likely to go viral on TikTok?",
            "Who is most likely to trip over nothing?",
            "Who is most likely to adopt 10 cats?",
            "Who is most likely to get arrested for something silly?",
            "Who is most likely to win a Nobel Prize?",
            "Who is most likely to be late to their own wedding?",
            "Who is most likely to spend all their money on food?",
            "Who is most likely to get lost in their own neighborhood?",
            "Who is most likely to become a stand-up comedian?"
        ];

        // UI Helpers
        const ui = {
            toast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                el.textContent = message;
                container.appendChild(el);

                el.offsetHeight; // trigger reflow
                el.classList.add('show');

                setTimeout(() => {
                    el.classList.remove('show');
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },

            setLoading(btnId, isLoading, originalText) {
                const btn = document.getElementById(btnId);
                if(!btn) return;
                if (isLoading) {
                    btn.disabled = true;
                    btn.innerHTML = `<span class="loading-spinner"></span> Loading...`;
                } else {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            },

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            },

            showPhase(phaseId) {
                ['phaseSetup', 'phaseVoting', 'phaseResults', 'phaseLeaderboard'].forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });
                document.getElementById(phaseId).style.display = 'block';
            }
        };

        // Initialize Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authStatus').style.display = 'none';
                document.getElementById('btnInitCreate').disabled = false;
                document.getElementById('btnInitJoin').disabled = false;

                document.getElementById('btnInitCreate').innerHTML = 'Create Game';
                document.getElementById('btnInitJoin').innerHTML = 'Join Game';
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error(error);
                    ui.toast('Failed to connect to server', 'error');
                });
            }
        });

        const game = {
            gameCode: null,
            playerName: null,
            players: {}, // local cache of player objects
            gameState: null,
            isHost: false,
            unsubscribe: null,

            // --- Lobby Actions ---

            async createGame() {
                const nameInput = document.getElementById('hostName');
                const name = nameInput.value.trim();

                if (!name) { ui.toast('Name required', 'error'); return; }
                ui.setLoading('btnCreate', true);

                this.playerName = name.replace(/</g, "&lt;");
                this.isHost = true;
                this.gameCode = Math.random().toString(36).substring(2, 6).toUpperCase();

                // Immediate UI update
                document.getElementById('lobbyCode').textContent = this.gameCode;

                try {
                    await setDoc(doc(db, 'games', this.gameCode), {
                        status: 'lobby',
                        createdAt: new Date(),
                        host: this.playerName,
                        players: {
                            [this.playerName]: {
                                name: this.playerName,
                                score: 0,
                                isHost: true,
                                joinedAt: new Date()
                            }
                        }
                    });
                    this.startListening();
                    this.showLobby();
                } catch (error) {
                    console.error(error);
                    ui.toast('Error creating game', 'error');
                } finally {
                    ui.setLoading('btnCreate', false, 'Create Room');
                }
            },

            async joinGame() {
                const nameInput = document.getElementById('joinName');
                const codeInput = document.getElementById('gameCode');
                const rawName = nameInput.value.trim();
                const code = codeInput.value.trim().toUpperCase();
                
                if (!rawName || code.length !== 4) { ui.toast('Invalid name or code', 'error'); return; }
                const safeName = rawName.replace(/</g, "&lt;");
                ui.setLoading('btnJoin', true);

                try {
                    const gameRef = doc(db, 'games', code);
                    const snap = await getDoc(gameRef);
                    
                    if (!snap.exists()) {
                        ui.toast("Room not found!", 'error');
                        ui.setLoading('btnJoin', false, 'Join Room');
                        return;
                    }

                    if (snap.data().status !== 'lobby') {
                        ui.toast("Game already started!", 'error');
                        ui.setLoading('btnJoin', false, 'Join Room');
                        return;
                    }

                    if (snap.data().players && snap.data().players[safeName]) {
                         ui.toast("Name taken!", 'error');
                         ui.setLoading('btnJoin', false, 'Join Room');
                         return;
                    }

                    await updateDoc(gameRef, {
                        [`players.${safeName}`]: {
                            name: safeName,
                            score: 0,
                            isHost: false,
                            joinedAt: new Date()
                        }
                    });

                    this.playerName = safeName;
                    this.gameCode = code;
                    this.startListening();
                    this.showLobby();
                } catch (error) {
                    console.error(error);
                    ui.toast("Error joining game.", 'error');
                } finally {
                    ui.setLoading('btnJoin', false, 'Join Room');
                }
            },

            // --- Game Flow Control ---

            async startGame() {
                if (!this.isHost) return;
                const btn = document.getElementById('startGameBtn');
                btn.disabled = true;
                btn.textContent = 'Starting...';

                const playerNames = Object.keys(this.players);
                // Shuffle turn order
                for (let i = playerNames.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [playerNames[i], playerNames[j]] = [playerNames[j], playerNames[i]];
                }

                try {
                    await updateDoc(doc(db, 'games', this.gameCode), {
                        status: 'playing',
                        phase: 'setup',
                        turnOrder: playerNames,
                        turnIndex: 0,
                        currentRound: 1,
                        setupCount: 0,
                        guesses: {}
                    });
                } catch (e) {
                    console.error(e);
                    ui.toast('Failed to start', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Start Game';
                }
            },

            async nextRound() {
                if(!this.isHost) return;

                // Calculate scores if moving from Results
                // (Already done locally, just syncing? No, host should write scores)
                // Actually, let's keep it simple: scores are updated during the reveal phase by the host client
                // but let's do it in the nextRound transition to be clean?
                // Or better: update scores IN the results phase immediately so they show up.
                // See renderGameLoop -> Results section logic.

                let nextIndex = this.gameState.turnIndex + 1;

                if (nextIndex >= this.gameState.turnOrder.length) {
                    await updateDoc(doc(db, 'games', this.gameCode), {
                        phase: 'leaderboard'
                    });
                } else {
                    await updateDoc(doc(db, 'games', this.gameCode), {
                        phase: 'voting',
                        turnIndex: nextIndex,
                        guesses: {}
                    });
                }
            },

            // --- Setup Phase Actions ---

            selectSetupQuestion(qText) {
                this.tempSetupQuestion = qText;
                document.getElementById('mySelectedQuestion').textContent = qText;
                document.getElementById('setupStep1').style.display = 'none';
                document.getElementById('setupStep2').style.display = 'block';

                // Render Player Options
                const container = document.getElementById('setupPlayerOptions');
                container.innerHTML = '';
                Object.values(this.players).forEach(p => {
                    const btn = document.createElement('div');
                    btn.className = 'player-choice-btn';
                    btn.textContent = p.name;
                    btn.onclick = () => this.submitSetup(p.name);
                    container.appendChild(btn);
                });
            },

            async submitSetup(selectedPlayerName) {
                if(!selectedPlayerName) return;

                document.getElementById('setupStep2').style.display = 'none';
                document.getElementById('setupWait').style.display = 'block';

                try {
                    await updateDoc(doc(db, 'games', this.gameCode), {
                        [`players.${this.playerName}.myQuestion`]: this.tempSetupQuestion,
                        [`players.${this.playerName}.myAnswer`]: selectedPlayerName
                    });
                } catch(e) {
                    console.error(e);
                    ui.toast("Error saving", 'error');
                    document.getElementById('setupStep2').style.display = 'block';
                    document.getElementById('setupWait').style.display = 'none';
                }
            },

            // --- Voting Phase Actions ---

            async submitVote(selectedPlayerName) {
                if(!selectedPlayerName) return;

                // Disable all buttons locally
                const btns = document.querySelectorAll('#votePlayerOptions .player-choice-btn');
                btns.forEach(b => b.style.pointerEvents = 'none');

                try {
                    await updateDoc(doc(db, 'games', this.gameCode), {
                        [`guesses.${this.playerName}`]: selectedPlayerName
                    });
                    document.getElementById('votingWait').style.display = 'block';
                    document.getElementById('votingActive').style.display = 'none';
                } catch(e) {
                    console.error(e);
                    ui.toast("Error submitting vote", 'error');
                    btns.forEach(b => b.style.pointerEvents = 'auto');
                }
            },

            // --- Listener & Rendering ---

            startListening() {
                if (this.unsubscribe) this.unsubscribe();
                console.log("Starting listener for", this.gameCode);
                this.unsubscribe = onSnapshot(doc(db, 'games', this.gameCode), (docSnap) => {
                    console.log("Snapshot received", docSnap.exists());
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.gameState = data;
                        this.players = data.players || {};
                        
                        if (data.status === 'playing') {
                            this.renderGameLoop();
                        } else {
                            this.updateLobbyUI();
                        }
                    } else {
                        ui.toast('Room closed', 'error');
                        setTimeout(() => location.reload(), 2000);
                    }
                }, (error) => {
                    console.error("Listener error:", error);
                });
            },

            updateLobbyUI() {
                ui.showScreen('lobbyScreen');
                const list = document.getElementById('lobbyPlayers');
                list.innerHTML = '';

                const playersList = Object.values(this.players).sort((a, b) => {
                    return (a.joinedAt?.seconds || 0) - (b.joinedAt?.seconds || 0);
                });

                playersList.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    div.innerHTML = `
                        <span class="player-name">${p.name}</span>
                        ${p.isHost ? '<span class="host-badge">HOST</span>' : ''}
                    `;
                    list.appendChild(div);
                });

                document.getElementById('lobbyCode').textContent = this.gameCode;

                if (this.isHost) {
                    const startBtn = document.getElementById('startGameBtn');
                    startBtn.style.display = 'block';
                }
            },

            renderGameLoop() {
                ui.showScreen('gameScreen');
                const { phase, turnOrder, turnIndex, players, guesses } = this.gameState;

                // HOST LOGIC: Check transitions and scoring
                if (this.isHost) {
                    // Transition Setup -> Voting
                    if (phase === 'setup') {
                        const allReady = Object.values(players).every(p => p.myQuestion && p.myAnswer);
                        if (allReady) {
                             updateDoc(doc(db, 'games', this.gameCode), { phase: 'voting' });
                        }
                    }
                    // Transition Voting -> Results + SCORING
                    if (phase === 'voting') {
                        const subjectName = turnOrder[turnIndex];
                        const guessers = turnOrder.filter(n => n !== subjectName);
                        const allGuessed = guessers.every(n => guesses && guesses[n]);

                        if (allGuessed && guessers.length > 0) {
                            // Calculate Scores
                            const subjectRealAnswer = players[subjectName].myAnswer;
                            const updates = { phase: 'results' };

                            Object.entries(guesses).forEach(([guesser, guess]) => {
                                if (guess === subjectRealAnswer) {
                                    // Increment score
                                    const currentScore = players[guesser].score || 0;
                                    updates[`players.${guesser}.score`] = currentScore + 100;
                                }
                            });

                            updateDoc(doc(db, 'games', this.gameCode), updates);
                        }
                    }
                }

                if (phase === 'setup') {
                    ui.showPhase('phaseSetup');
                    if (players[this.playerName].myAnswer) {
                        document.getElementById('setupStep1').style.display = 'none';
                        document.getElementById('setupStep2').style.display = 'none';
                        document.getElementById('setupWait').style.display = 'block';
                    } else {
                         if (document.getElementById('setupStep2').style.display === 'none') {
                             document.getElementById('setupStep1').style.display = 'block';
                             const container = document.getElementById('setupOptions');
                             if(container.innerHTML === '') {
                                 const shuffled = [...QUESTIONS_BANK].sort(() => 0.5 - Math.random()).slice(0,3);
                                 shuffled.forEach(q => {
                                     const btn = document.createElement('button');
                                     btn.className = 'option-btn';
                                     btn.textContent = q;
                                     btn.onclick = () => this.selectSetupQuestion(q);
                                     container.appendChild(btn);
                                 });
                             }
                         }
                    }
                }
                else if (phase === 'voting') {
                    ui.showPhase('phaseVoting');
                    const subjectName = turnOrder[turnIndex];
                    const subjectData = players[subjectName];
                    const isSubject = (this.playerName === subjectName);

                    document.getElementById('votingSubject').textContent = subjectName;
                    document.getElementById('votingSubjectRef').textContent = subjectName;
                    document.getElementById('votingQuestion').textContent = subjectData.myQuestion || "Error";

                    if (isSubject) {
                        document.getElementById('votingActive').style.display = 'none';
                        document.getElementById('votingPassive').style.display = 'block';
                        document.getElementById('votingWait').style.display = 'none';
                    } else {
                        document.getElementById('votingPassive').style.display = 'none';

                        if (guesses && guesses[this.playerName]) {
                            document.getElementById('votingActive').style.display = 'none';
                            document.getElementById('votingWait').style.display = 'block';
                        } else {
                            document.getElementById('votingActive').style.display = 'block';
                            document.getElementById('votingWait').style.display = 'none';

                            // Render Options
                            const container = document.getElementById('votePlayerOptions');
                            container.innerHTML = '';
                            Object.values(players).forEach(p => {
                                const btn = document.createElement('div');
                                btn.className = 'player-choice-btn';
                                btn.textContent = p.name;
                                btn.onclick = () => this.submitVote(p.name);
                                container.appendChild(btn);
                            });
                        }
                    }
                }
                else if (phase === 'results') {
                    ui.showPhase('phaseResults');
                    const subjectName = turnOrder[turnIndex];
                    const subjectData = players[subjectName];

                    document.getElementById('resultQuestion').textContent = subjectData.myQuestion;
                    document.getElementById('resultSubjectName').textContent = subjectName;
                    document.getElementById('resultRealAnswer').textContent = subjectData.myAnswer;

                    const list = document.getElementById('guessesList');
                    list.innerHTML = '';
                    if (guesses) {
                        Object.entries(guesses).forEach(([guesser, guess]) => {
                            const isCorrect = (guess === subjectData.myAnswer);
                            const div = document.createElement('div');
                            div.style.padding = '0.5rem';
                            div.style.borderBottom = '1px solid #eee';
                            div.innerHTML = `
                                <b>${guesser}</b> guessed: ${guess}
                                ${isCorrect ? '<span class="points-badge">+100</span>' : ''}
                            `;
                            list.appendChild(div);
                        });
                    }

                    if (this.isHost) {
                        document.getElementById('hostControls').style.display = 'block';
                        document.getElementById('playerControls').style.display = 'none';
                    } else {
                        document.getElementById('hostControls').style.display = 'none';
                        document.getElementById('playerControls').style.display = 'block';
                    }
                }
                else if (phase === 'leaderboard') {
                    ui.showPhase('phaseLeaderboard');
                    // Sort by score
                    const sortedPlayers = Object.values(players).sort((a,b) => (b.score||0) - (a.score||0));

                    const table = document.getElementById('finalScores');
                    table.innerHTML = `<tr><td>Player</td><td>Score</td></tr>` +
                        sortedPlayers.map((p, i) => `
                            <tr>
                                <td>${i+1}. ${p.name}</td>
                                <td>${p.score || 0}</td>
                            </tr>
                        `).join('');
                }
            },

            // --- Nav ---
            showCreateGame() { ui.showScreen('createGameScreen'); setTimeout(() => document.getElementById('hostName').focus(), 100); },
            showJoinGame() { ui.showScreen('joinGameScreen'); setTimeout(() => document.getElementById('joinName').focus(), 100); },
            showHome() { ui.showScreen('homeScreen'); },
            showLobby() { ui.showScreen('lobbyScreen'); },
        };
        window.game = game;

        // Key handlers
        document.getElementById('hostName').addEventListener('keypress', (e) => { if (e.key === 'Enter') game.createGame(); });
        document.getElementById('joinName').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('gameCode').focus(); });
        document.getElementById('gameCode').addEventListener('keypress', (e) => { if (e.key === 'Enter') game.joinGame(); });
    </script>
</body>
</html>
